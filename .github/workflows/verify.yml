name: Verify Morpho Verity

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  verity-proofs:
    name: Lean proofs (Verity)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Restore Lean/Lake cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ~/.lake
            .lake/packages
            .lake/build
          key: ${{ runner.os }}-lean-lake-${{ hashFiles('lean-toolchain', 'lake-manifest.json', 'lakefile.lean') }}
          restore-keys: |
            ${{ runner.os }}-lean-lake-

      - name: Install Lean toolchain
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Build and check proofs
        run: lake build

      - name: Run Morpho compiler CLI regression tests
        run: lake build Morpho.Compiler.MainTest

  parity-target:
    name: Parity target tuple check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Restore solc-select cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.solc-select
          key: ${{ runner.os }}-solc-select-${{ hashFiles('config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-solc-select-

      - name: Install solc
        run: |
          SOLC_VERSION=0.8.28
          if ! command -v solc-select >/dev/null 2>&1; then
            pip3 install solc-select
          fi
          if ! solc-select versions | grep -q "${SOLC_VERSION}"; then
            solc-select install "${SOLC_VERSION}"
          fi
          solc-select use "${SOLC_VERSION}"

      - name: Validate pinned parity target
        run: python3 scripts/check_parity_target.py

      - name: Run parity-target parser regression tests
        run: python3 scripts/test_check_parity_target.py

      - name: Run Yul identity report unit tests
        run: python3 scripts/test_report_yul_identity_gap.py

  yul-identity-report:
    name: Yul identity gap report (Solidity vs Verity)
    runs-on: ubuntu-latest
    needs: [parity-target]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Restore Lean/Lake cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ~/.lake
            .lake/packages
            .lake/build
          key: ${{ runner.os }}-lean-lake-${{ hashFiles('lean-toolchain', 'lake-manifest.json', 'lakefile.lean') }}
          restore-keys: |
            ${{ runner.os }}-lean-lake-

      - name: Install Lean toolchain
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Restore Foundry cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry/cache
            ~/.foundry/bin
            ~/.svm
            morpho-blue/cache
            morpho-blue/out
          key: ${{ runner.os }}-foundry-${{ hashFiles('morpho-blue/foundry.toml', 'config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore solc-select cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.solc-select
          key: ${{ runner.os }}-solc-select-${{ hashFiles('config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-solc-select-

      - name: Install solc
        run: |
          SOLC_VERSION=0.8.28
          if ! command -v solc-select >/dev/null 2>&1; then
            pip3 install solc-select
          fi
          if ! solc-select versions | grep -q "${SOLC_VERSION}"; then
            solc-select install "${SOLC_VERSION}"
          fi
          solc-select use "${SOLC_VERSION}"

      - name: Generate Yul identity report
        run: python3 scripts/report_yul_identity_gap.py --max-diff-lines 12000 --enforce-unsupported-manifest

      - name: Upload Yul identity artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: yul-identity-report
          path: out/parity-target
          if-no-files-found: error

  solidity-tests:
    name: Solidity tests (Foundry)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Restore Foundry cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry/cache
            ~/.foundry/bin
            ~/.svm
            morpho-blue/cache
            morpho-blue/out
          key: ${{ runner.os }}-foundry-${{ hashFiles('morpho-blue/foundry.toml', 'config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run Morpho Blue tests
        working-directory: morpho-blue
        run: forge test -vvv
        env:
          FOUNDRY_FUZZ_RUNS: ${{ github.event_name == 'pull_request' && '1500' || '10000' }}
          FOUNDRY_FUZZ_MAX_TEST_REJECTS: 500000
          FOUNDRY_INVARIANT_RUNS: ${{ github.event_name == 'pull_request' && '1500' || '10000' }}
          FOUNDRY_INVARIANT_DEPTH: 32

  verity-compiled-tests:
    name: Verity compiled artifact smoke tests (Foundry)
    runs-on: ubuntu-latest
    needs: [parity-target]
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Restore Lean/Lake cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ~/.lake
            .lake/packages
            .lake/build
          key: ${{ runner.os }}-lean-lake-${{ hashFiles('lean-toolchain', 'lake-manifest.json', 'lakefile.lean') }}
          restore-keys: |
            ${{ runner.os }}-lean-lake-

      - name: Install Lean toolchain
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Restore Foundry cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry/cache
            ~/.foundry/bin
            ~/.svm
            morpho-blue/cache
            morpho-blue/out
          key: ${{ runner.os }}-foundry-${{ hashFiles('morpho-blue/foundry.toml', 'config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore solc-select cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.solc-select
          key: ${{ runner.os }}-solc-select-${{ hashFiles('config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-solc-select-

      - name: Install solc
        run: |
          SOLC_VERSION=0.8.28
          if ! command -v solc-select >/dev/null 2>&1; then
            pip3 install solc-select
          fi
          if ! solc-select versions | grep -q "${SOLC_VERSION}"; then
            solc-select install "${SOLC_VERSION}"
          fi
          solc-select use "${SOLC_VERSION}"

      - name: Compile Morpho Verity artifact and enforce model/edsl parity
        run: ./scripts/check_input_mode_parity.sh

      - name: Run Verity artifact smoke tests
        working-directory: verity-foundry
        run: forge test -vvv
        env:
          FOUNDRY_FUZZ_RUNS: ${{ github.event_name == 'pull_request' && '500' || '1000' }}
          FOUNDRY_FUZZ_MAX_TEST_REJECTS: 500000

  morpho-blue-parity:
    name: Morpho Blue differential suite (Solidity vs Verity)
    runs-on: ubuntu-latest
    needs: [parity-target]
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Restore Lean/Lake cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ~/.lake
            .lake/packages
            .lake/build
          key: ${{ runner.os }}-lean-lake-${{ hashFiles('lean-toolchain', 'lake-manifest.json', 'lakefile.lean') }}
          restore-keys: |
            ${{ runner.os }}-lean-lake-

      - name: Install Lean toolchain
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> "$GITHUB_PATH"

      - name: Restore Foundry cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.foundry/cache
            ~/.foundry/bin
            ~/.svm
            morpho-blue/cache
            morpho-blue/out
          key: ${{ runner.os }}-foundry-${{ hashFiles('morpho-blue/foundry.toml', 'config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-foundry-

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Restore solc-select cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.solc-select
          key: ${{ runner.os }}-solc-select-${{ hashFiles('config/parity-target.json') }}
          restore-keys: |
            ${{ runner.os }}-solc-select-

      - name: Install solc
        run: |
          SOLC_VERSION=0.8.28
          if ! command -v solc-select >/dev/null 2>&1; then
            pip3 install solc-select
          fi
          if ! solc-select versions | grep -q "${SOLC_VERSION}"; then
            solc-select install "${SOLC_VERSION}"
          fi
          solc-select use "${SOLC_VERSION}"

      - name: Run full Morpho Blue parity script
        run: ./scripts/run_morpho_blue_parity.sh
        env:
          FOUNDRY_FUZZ_RUNS: ${{ github.event_name == 'pull_request' && '1500' || '10000' }}
          FOUNDRY_FUZZ_MAX_TEST_REJECTS: 500000
          FOUNDRY_INVARIANT_RUNS: ${{ github.event_name == 'pull_request' && '1500' || '10000' }}
          FOUNDRY_INVARIANT_DEPTH: 32

      - name: Upload parity logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: morpho-blue-parity-logs
          path: out/parity/*.log
          if-no-files-found: error
